# Build Log Comparator

Универсальная утилита для сравнения предупреждений компилятора между двумя сборочными логами.

## Описание

Build Log Comparator анализирует два лога сборки и показывает, какие предупреждения (Warning) и подсказки (Hint) добавились, исчезли или остались без изменений. Утилита особенно полезна когда сборочный сервер блокирует сборку из-за увеличения количества предупреждений, но не показывает детали изменений.

## Установка

### Требования

- Python 3.8 или выше

### Установка зависимостей

```bash
pip install -r requirements.txt
```

## Использование

### Базовое использование

```bash
python -m src.main <старый_лог> <новый_лог>
```

Пример:

```bash
python -m src.main example/D7OrionPro_DevelopBuild_24782.log example/D7OrionPro_DevelopBuild_24787.log
```

### Использование с конфигурацией

```bash
python -m src.main <старый_лог> <новый_лог> --config config/custom.yaml
```

### Отключение цветного вывода

```bash
python -m src.main <старый_лог> <новый_лог> --no-color
```

### Справка

```bash
python -m src.main --help
```

## Конфигурация

Утилита поддерживает настройку через YAML файлы. По умолчанию используются настройки из `config/default.yaml` для проекта OrionPro.

### Создание собственной конфигурации

Создайте файл конфигурации (например, `config/custom.yaml`) и укажите его при запуске:

```bash
python -m src.main old.log new.log --config config/custom.yaml
```

### Анализ всех этапов сборки

Чтобы проанализировать все этапы сборки без фильтрации, используйте паттерн `"*"`:

```yaml
target_steps:
  - pattern: "*"
    name: "all"
```

Или создайте файл `config/all_steps.yaml`:

```bash
python -m src.main old.log new.log --config config/all_steps.yaml
```

### Параметры конфигурации

Пример конфигурационного файла:

```yaml
# Этапы для анализа
target_steps:
  - pattern: "Step 4/21: BuildOrionPRO"
    name: "BuildOrionPRO"

# Маркеры вложенных этапов
stage_markers:
  - "<build>"
  - "<brcc>"
  - "<dcc>"

# Паттерны предупреждений
warning_patterns:
  - pattern: "Warning:"
    type: "Warning"
  - pattern: "Hint:"
    type: "Hint"
  - pattern: "[vip][warning]"
    type: "Warning"

# Игнорируемые паттерны (для фильтрации временных меток и путей)
ignore_patterns:
  timestamp: "^\\[\\d{2}:\\d{2}:\\d{2}\\]"
  path_prefix: "N:\\\\BuildArea\\\\[^\\\\]+\\\\"

# Настройки вывода
output:
  use_colors: true
  show_unchanged_count: true
  group_by_stage: true

# Настройки сравнения
comparison:
  ignore_case: false  # Игнорировать регистр при сравнении
```

### Описание параметров

- **target_steps**: Список этапов сборки для анализа. Каждый этап содержит:
  - `pattern`: Регулярное выражение для поиска этапа в логе (используйте `"*"` для анализа всех этапов)
  - `name`: Имя этапа для отображения в отчёте

- **stage_markers**: Маркеры начала вложенных этапов (например, `<build>`, `<dcc>`)

- **warning_patterns**: Паттерны для поиска предупреждений в тексте лога. Каждый паттерн содержит:
  - `pattern`: Текст для поиска в строке
  - `type`: Тип предупреждения ("Warning" или "Hint")

- **ignore_patterns**: Паттерны для нормализации текста при сравнении:
  - `timestamp`: Регулярное выражение для удаления временных меток
  - `path_prefix`: Регулярное выражение для удаления абсолютных путей

- **output**: Настройки форматирования вывода:
  - `use_colors`: Использовать цветной вывод (true/false)
  - `show_unchanged_count`: Показывать количество неизменных предупреждений (true/false)
  - `group_by_stage`: Группировать предупреждения по этапам сборки (true/false)

- **comparison**: Настройки сравнения:
  - `ignore_case`: Игнорировать регистр букв при сравнении предупреждений (true/false)

## Структура проекта

```text
build-log-comparator/
├── src/                    # Исходный код
│   ├── __init__.py
│   ├── main.py            # Точка входа, CLI интерфейс
│   ├── config.py          # Загрузка и валидация конфигурации
│   ├── parser.py          # Парсинг структуры логов
│   ├── extractor.py       # Извлечение предупреждений
│   ├── comparator.py      # Сравнение предупреждений
│   └── reporter.py        # Генерация отчётов
├── config/                # Конфигурационные файлы
│   └── default.yaml
├── examples/              # Примеры логов
├── tests/                 # Тесты
├── requirements.txt       # Зависимости
└── README.md             # Документация
```

## Запуск тестов

```bash
# Запуск всех тестов
pytest

# Запуск с измерением покрытия
pytest --cov=src --cov-report=html

# Запуск конкретного теста
pytest tests/test_parser.py
```

## Разработка

### Форматирование кода

```bash
black src/ tests/
```

### Проверка стиля

```bash
flake8 src/ tests/
```

### Проверка типов

```bash
mypy src/
```

## Примеры вывода

### Общая сводка

```text
╔══════════════════════════════════════════════════════════════╗
║              СВОДКА СРАВНЕНИЯ СБОРОЧНЫХ ЛОГОВ                ║
╠══════════════════════════════════════════════════════════════╣
║ Старый лог: example/D7OrionPro_DevelopBuild_24782.log       ║
║ Новый лог:  example/D7OrionPro_DevelopBuild_24787.log       ║
╚══════════════════════════════════════════════════════════════╝

┌─ ОБЩАЯ СТАТИСТИКА ────────────────────────────────────────┐
│ Warnings:  140 → 144 (+4)
│ Hints:     2702 → 2716 (+14)
│ Всего:     2842 → 2860 (+18)
└────────────────────────────────────────────────────────────┘

┌─ ПО ЭТАПАМ СБОРКИ ─────────────────────────────────────────┐
│ <brcc>
│   Hints:    134 → 134 
│
│ <dcc>
│   Warnings: 2 → 6 (+4)
│   Hints:    2352 → 2366 (+14)
│
└────────────────────────────────────────────────────────────┘
```

### Детальные изменения

```text
╔══════════════════════════════════════════════════════════════╗
║                    ДЕТАЛЬНЫЕ ИЗМЕНЕНИЯ                       ║
╚══════════════════════════════════════════════════════════════╝

┌─ <dcc> ─────────────────────────────────────────────────────┐
│                                                            │
│ ✚ ДОБАВЛЕНО (6 warnings, 62 hints):
│                                                            │
│   [Warning] [15:51:08] : [<dcc>]
│             N:\BuildArea\...\u_conf.pas(20365)
│             Warning: Variable 'VValue' might not have been
│             initialized
│   [Hint] [15:51:00] : [<dcc>] Hint: Value assigned to
│          'DragIndexPos' never used
│   ...
│                                                            │
│ ✖ УДАЛЕНО (2 warnings, 48 hints):
│                                                            │
│   [Warning] [14:13:55] : [<dcc>] Warning: Symbol
│             'ICoOriCoreEventEvents' is specific to a
│             platform
│   [Hint] [14:13:34] : [<dcc>] tResultConvet.pas(1105) Hint:
│          Value assigned to 'TOriAnswerParser.ParseIt_T'
│          never used
│   ...
│                                                            │
│ ═ БЕЗ ИЗМЕНЕНИЙ: 2304 предупреждений
└────────────────────────────────────────────────────────────┘
```
